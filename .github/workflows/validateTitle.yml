name: ValidatePRTitle

on:
  pull_request:
    types: [opened, edited, reopened, synchronize]
    branches: 
      - master
env:
  GITHUB_PR_NUMBER: ${{github.event.pull_request.number}}
  
jobs:
  validatePR:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v2
      
      - name: Read Jira Issue Status
        id: retrieveJiraStatus    
        run: |
        
             restApiGETStatus=$(curl --request GET \
                  --url 'https://naregkar.atlassian.net/rest/api/3/issue/DT-11/' \
                  --user 'nareg.karamanoukian@picsart.com:oBJTrxuI3qf0Do1MBpGbBE87' \
                  --header 'Accept: application/json' | jq -r '.fields.status.name');                   
            
              echo "JiraIssue_Status=$restApiGETStatus" >> $GITHUB_ENV
      
      - name: Assess the Jira Status
        run: |
               echo 'status:' ${{ env.JiraIssue_Status }}
               
               curl -D- -u nareg.karamanoukian@picsart.com:oBJTrxuI3qf0Do1MBpGbBE87 \
                   -X PUT --data '{ "fields": { "customfield_10029" : "'"$GITHUB_WORKFLOW_ID"'" }}' \
                   -H "Content-Type: application/json" https://naregkar.atlassian.net/rest/api/3/issue/DT-11
               
               toMergeStatus="Ready to Merge"
               
               if [[ "${{ env.JiraIssue_Status }}" == "$toMergeStatus" ]]; then
                 echo "PR can be merged to master"
               else
                 echo "Jira Issue's status is not Ready to Merge. Cannot Merge to master."
                 exit 1
               fi

