name: TriggerRCVersion

on:
  push:
    paths:
      - 'package.json'
env:
  GITHUB_PR_NUMBER: ${{github.event.pull_request.number}}
  GITHUB_WORKFLOW_ID: ${{github.run_id}}
  GITHUB_REPOSITORY_NAME: ${{ github.event.repository.name }}
  
jobs:
  TriggerRCVersion:
    runs-on: ubuntu-latest
    
    steps:
    
        - name: Extract branch name
          run: |
                 echo "PR_Branch_Name=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV  
                 
        - name: Read json file from the master branch
          run : |
                 contentMaster=$(curl -H "Accept: application/vnd.github.v3+json" https://api.github.com/repos/naregkar/repo1/contents/package.json | jq -r '.content')
                 parsedJSON=$(echo "$contentMaster" | base64 -d)
                 
                 RCVersionMaster=$(echo $parsedJSON |  jq -r '.dependencies."@pa/rc"')
                 echo "RCVersionMaster=$RCVersionMaster" >> $GITHUB_ENV
                 
                 echo $RCVersionMaster
                
        - name: Read json file from the current branch
          run: |
                 contentBranch=$(curl -H "Accept: application/vnd.github.v3+json" https://api.github.com/repos/naregkar/repo1/contents/package.json?ref=${{ env.PR_Branch_Name }} | jq -r '.content')
                 parsedJSON=$(echo "$contentBranch" | base64 -d)
                 
                 RCVersionBranch=$(echo $parsedJSON |  jq -r '.dependencies."@pa/rc"')
                 echo "RCVersionBranch=$RCVersionBranch" >> $GITHUB_ENV 
                 
                 echo $RCVersionBranch

        - name: Compare Versions
          run:  |
                  CompareMainPart() {
                    RCVersionBranch=$1
                    RCVersionMaster=$2
                    echo 'CompareMainPart - RCVersionBranch:' $RCVersionBranch
                    echo 'CompareMainPart - RCVersionMaster:' $RCVersionMaster
                    majorBranch=`echo $RCVersionBranch | cut -d. -f1`
                    minorBranch=`echo $RCVersionBranch | cut -d. -f2`
                    revisionBranch=`echo $RCVersionBranch | cut -d. -f3`
                    
                    majorMaster=`echo $RCVersionMaster | cut -d. -f1`
                    minorMaster=`echo $RCVersionMaster | cut -d. -f2`
                    revisionMaster=`echo $RCVersionMaster | cut -d. -f3`
                    
                    echo 'majorBranch: ' $majorBranch
                    echo 'minorBranch: ' $minorBranch
                    echo 'revisionBranch: ' $revisionBranch
                    
                    echo 'majorMaster: ' $majorMaster
                    echo 'minorMaster: ' $minorMaster
                    echo 'revisionMaster: ' $revisionMaster
                    
                    sendNotification=0
                    if [[ "$majorBranch" -eq "$majorMaster" ]]; then
                      
                        echo 'first'
                      
                        if [[ "$minorBranch" -eq "$minorMaster" ]]; then
                            echo 'second'
                            if [[ "$revisionBranch" -eq "$revisionMaster" ]]; then
                                echo 'third'
                                sendNotification=0
                            else
                                if [[ "$revisionBranch" -gt "$revisionMaster" ]]; then
                                  sendNotification=1
                                else
                                  sendNotification=0
                                fi		
                            fi
                        else
                          if [[ "$minorBranch" -gt "$minorMaster" ]]; then
                            echo 'inside 1'
                            sendNotification=1
                          else
                            echo 'inside 2'
                            sendNotification=0
                          fi		
                      fi
                    else
                      if [[ "$majorBranch" -gt "$majorMaster" ]]; then
                        sendNotification=1
                      else
                        sendNotification=0
                      fi		
                    fi
                    
                    echo 'sendNotification before return is:' $sendNotification
                    #return 1
                    echo $sendNotification
                  }
                  
                  RCVersionBranch=${{ env.RCVersionBranch }}
                  RCVersionMaster=${{ env.RCVersionMaster }}
                  
                  echo 'RCVersionBranch:' $RCVersionBranch
                  echo 'RCVersionMaster:' $RCVersionMaster
                  
                  branchContainsHyphen=false
                  masterContainsHyphen=false
                  if [[ $RCVersionBranch =~ "-" ]]; then
                    branchContainsHyphen=true
                  fi
                  if [[ $RCVersionMaster =~ "-" ]]; then
                    masterContainsHyphen=true
                  fi
                  if [[ $branchContainsHyphen == "true" ]] && [[ $masterContainsHyphen == "true" ]]; then
                    echo 'both have hyphens'
                    beforeHyphenRelease=${RCVersionBranch%%-*}
                    beforeHyphenMaster=${RCVersionMaster%%-*}
                    afterHyphenRelease=${RCVersionBranch##*-}
                    afterHyphenMaster=${RCVersionMaster##*-}
                    if [[ $beforeHyphenRelease == $beforeHyphenMaster ]]; then
                      if [[ $afterHyphenRelease == $afterHyphenMaster ]]; then
                        sendNotification=0
                        echo 'after dash are equal, same versions'
                      else
                        if [[ $afterHyphenRelease -gt $afterHyphenMaster ]]; then
                          sendNotification=1
                          echo 'notify as release after dash is greater: ' $sendNotification
                        else
                          sendNotification=0
                          echo 'do not notify as master after dash is greater:' $sendNotification
                        fi
                      fi	
                    else
                      CompareMainPart $beforeHyphenRelease $beforeHyphenMaster
                      returnResult=$?
                      if [[ $returnResult == 0 ]]; then
                        sendNotification=0
                        echo 'no need to notify as master is greater:' $sendNotification
                      else
                        sendNotification=1
                        echo 'notify as branch is greater:' $sendNotification
                      fi
                    fi
                  elif [[ $branchContainsHyphen == "true" ]] && [[ $masterContainsHyphen == "false" ]]; then
                    #in case the branch contains a hyphen and the master is in x.y.z format
                    echo 'true branch/false master'
                    beforeHyphenRelease=${RCVersionBranch%%-*}
                    CompareMainPart $beforeHyphenRelease $RCVersionMaster
                    returnResult=$?
                    
                    if [[ $returnResult == 0 ]]; then
                    
                      afterHyphenRelease=${RCVersionBranch##*-}
                      
                      if [[ $afterHyphenRelease -gt 0 ]]; then
                        sendNotification=1
                        echo 'notify as branch is greater:' $sendNotification
                      else
                        sendNotification=0
                        echo 'no need to notify as master is greater:' $sendNotification
                      fi
                    else
                      sendNotification=1
                      echo 'notify as branch is greater:' $sendNotification
                    fi
                  elif [[ $branchContainsHyphen == "false" ]] && [[ $masterContainsHyphen == "true" ]]; then
                      #in case the branch is in x.y.z format and the master contains a hyphen
                      
                      echo 'false branch/true master'
                      beforeHyphenMaster=${RCVersionMaster%%-*}
                      CompareMainPart $RCVersionBranch $beforeHyphenMaster
                      returnResult=$?
                      
                      if [[ $returnResult == 0 ]]; then
                        
                        afterHyphenMaster=${RCVersionMaster##*-}
                        
                        if [[ $afterHyphenMaster -gt 0 ]]; then
                          sendNotification=0
                          echo 'do not notify as master is greater:' $sendNotification
                        else
                          sendNotification=0
                          echo 'do not notify as master is greater:' $sendNotification
                        fi
                      else
                        sendNotification=1
                        echo 'notify as branch is greater:' $sendNotification
                      fi
                    else
                      echo 'no hyphens in both branch and master'
                      CompareMainPart $RCVersionBranch $RCVersionMaster
                      returnResult=$?
                      
                      if [[ $returnResult == 1 ]]; then
                        sendNotification=1
                      else
                        sendNotification=0
                      fi
                      
                      echo 'sendNotification for no hyphens is:' $sendNotification
                    fi
                    
                    echo 'before slack'
                    echo 'sendNotification before slack is:' $sendNotification
                    
                    if [[ $sendNotification == 1 ]]; then
                       echo "SendNotificationToSlack=$sendNotification" >> $GITHUB_ENV 
                    fi
        
        - name: Send Slack Notification
          uses: someimportantcompany/github-actions-slack-message@v1
          if: env.SendNotificationToSlack == 1
          with:
            webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
            text: NEW RC Version has been utilized
            color: success

        - name: Dump GitHub context
          env:
            GITHUB_CONTEXT: ${{ toJson(github) }}
          run: echo "$GITHUB_CONTEXT"
